<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>TLC/PCNL Dashboard - HWH Division</title>

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" rel="stylesheet">

<style>
/* === YOUR ORIGINAL CSS ‚Äî UNCHANGED === */
body { background:#f1f4f8;font-family:"Segoe UI",Roboto,Arial,sans-serif;margin:0;}
.app{display:flex;min-height:100vh;}
.sidebar{width:240px;background:#0b3c6f;color:white;display:flex;flex-direction:column;}
.sidebar h4{padding:15px;text-align:center;border-bottom:1px solid rgba(255,255,255,0.2);}
.menu{flex:1;padding:10px;}
.menu button{width:100%;background:none;border:none;color:white;padding:12px 15px;text-align:left;border-radius:8px;margin-bottom:5px;}
.menu button:hover,.menu button.active{background:rgba(255,255,255,0.15);}
.main{flex:1;display:flex;flex-direction:column;}
.header{background:linear-gradient(135deg,#003366,#0b4fa2);color:white;padding:12px 20px;display:flex;align-items:center;justify-content:space-between;height:64px;overflow:hidden;}
.content{flex:1;padding:20px;}
.footer{background:#eef2f7;padding:8px 20px;text-align:center;font-size:.85rem;}
#weatherBox{min-width:260px;max-width:260px;max-height:52px;overflow:hidden;padding:6px 10px;border-radius:10px;background:rgba(255,255,255,.15);font-size:.8rem;}
#stationSuggest{background:#fff;color:#0f172a;border:1px solid #e2e8f0;position:absolute;top:38px;right:0;z-index:9999;width:260px;max-height:220px;overflow-y:auto;display:none;}
#stationSuggest .suggest-item{padding:6px 10px;cursor:pointer;}
#stationSuggest .suggest-item:hover{background:#e8f0ff;}
</style>
</head>
<body>

<div class="app">
<div class="sidebar">
  <h4><i class="fa-solid fa-train"></i> TLC/PCNL</h4>
  <div class="menu">
    <button class="active" onclick="loadCrewModule(this)">
      <i class="fa-solid fa-users"></i> Crew Search
    </button>
    <button onclick="window.location.href='/speed'">
      <i class="fa-solid fa-gauge-high"></i> Speed Analyzer
    </button>
  </div>
</div>

<div class="main">
<div class="header">
  <div class="d-flex align-items-center gap-3">
    <img src="/logo.png" height="40" onerror="this.style.display='none'">
    <div>
      <div class="fw-bold">TLC / PCNL Dashboard ‚Äî HWH Division</div>
      <small>Eastern Railway</small>
    </div>
  </div>

  <div class="d-flex align-items-center gap-3">
    <div class="d-flex align-items-center gap-2 position-relative">
      <input id="stationSearch" class="form-control form-control-sm"
        placeholder="Search Station / Code" autocomplete="off" style="width:160px;">
      <div id="stationSuggest"></div>
      <div id="weatherBox">üå§Ô∏è Select Station</div>
    </div>
    <div id="clock"></div>
  </div>
</div>

<div id="content" class="content"></div>

<div class="footer">
  Developed by S Samanta / APCNL
</div>
</div>
</div>

<script>
/* ================= CLOCK ================= */
function updateClock() {
  document.getElementById("clock").innerText = new Date().toLocaleString();
}
setInterval(updateClock, 1000);
updateClock();

/* ================= CREW MODULE ================= */
function loadCrewModule(btn) {
  document.getElementById("content").innerHTML = `
    <h4><i class="fa-solid fa-users"></i> Crew Search</h4>
    <input id="search" class="form-control" placeholder="Search Crew ID or Name">
    <div id="suggestions" class="list-group mt-2"></div>
    <div id="resultBox" class="mt-3"></div>
  `;
  initCrewSearch();
}

/* ================= CREW SEARCH ================= */
let timer = null;

async function fetchSuggestions(q) {
  const res = await fetch(`/suggest?q=${encodeURIComponent(q)}`);
  return await res.json();
}

async function fetchProfile(id) {
  const res = await fetch(`/search?q=${encodeURIComponent(id)}`);
  return await res.json();
}

function initCrewSearch() {
  const input = document.getElementById("search");
  const box = document.getElementById("suggestions");

  input.addEventListener("input", () => {
    clearTimeout(timer);
    const q = input.value.trim();
    if (!q) return box.innerHTML = "";

    timer = setTimeout(async () => {
      const list = await fetchSuggestions(q);
      box.innerHTML = list.map(i => `
        <div class="list-group-item suggest-item"
          onclick="selectCrew('${i.crew_id}')">
          <b>${i.crew_id}</b> ‚Äî ${i.crew_name}
        </div>
      `).join("");
    }, 300);
  });
}

async function selectCrew(id) {
  const data = await fetchProfile(id);
  const box = document.getElementById("resultBox");
  if (!data) return box.innerHTML = "No crew found";

  box.innerHTML = `
    <h5>${data.crew_name}</h5>
    <div>ID: ${data.crew_id}</div>
    <div>Mobile: ${data.mobile || "N/A"}</div>
    <div>Designation: ${data.designation || "N/A"}</div>
  `;
}

/* ================= STATION SEARCH ================= */
const stationInput = document.getElementById("stationSearch");
const stationBox = document.getElementById("stationSuggest");

stationInput.addEventListener("input", async () => {
  const q = stationInput.value.trim();
  if (!q) return stationBox.style.display = "none";

  const res = await fetch(`/api/stations?q=${encodeURIComponent(q)}`);
  const list = await res.json();

  stationBox.innerHTML = list.map(s => `
    <div class="suggest-item"
      onclick="selectStation('${s.code}')">
      <b>${s.code}</b> ‚Äî ${s.name}
    </div>
  `).join("");

  stationBox.style.display = "block";
});

/* ================= WEATHER ================= */
async function selectStation(code) {
  stationBox.style.display = "none";
  stationInput.value = code;
  loadWeather(code);
}

async function loadWeather(code) {
  const box = document.getElementById("weatherBox");
  box.innerText = "‚è≥ Loading weather...";

  try {
    const res = await fetch(`/api/weather?station=${code}`);
    const data = await res.json();

    const w = data.weather.current;
    box.innerHTML = `
      üå°Ô∏è ${w.temp_c}¬∞C
      üíß ${w.humidity}%
      üå•Ô∏è ${w.condition.text}
    `;
  } catch (e) {
    box.innerText = "‚ö†Ô∏è Weather Unavailable";
  }
}

/* ================= DEFAULT LOAD ================= */
document.addEventListener("DOMContentLoaded", () => {
  loadCrewModule();
});
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
